============================= test session starts ==============================
platform darwin -- Python 3.13.7, pytest-8.4.2, pluggy-1.6.0 -- /Users/tglenn/src/govee-ultimate/.venv/bin/python
cachedir: .pytest_cache
rootdir: /Users/tglenn/src/govee-ultimate
plugins: respx-0.22.0, pytest_freezer-0.4.9, unordered-0.7.0, asyncio-1.2.0, anyio-4.11.0, syrupy-4.9.1, sugar-1.0.0, socket-0.7.0, xdist-3.8.0, timeout-2.4.0, homeassistant-custom-component-0.13.289, github-actions-annotate-failures-0.3.0, aiohttp-1.1.0, picked-0.5.1, requests-mock-1.12.1, cov-7.0.0
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 28 items

tests/test_config_flow.py::test_stub_flow_result_type_includes_docstring PASSED [  3%]
tests/test_config_flow.py::test_user_flow_requests_credentials_before_submission PASSED [  7%]
tests/test_config_flow.py::test_user_flow_creates_entry_with_credentials_and_flags PASSED [ 10%]
tests/test_config_flow.py::test_options_flow_allows_configuring_iot_toggles FAILED [ 14%]
tests/test_config_flow.py::test_user_flow_validates_credentials_before_creating_entry PASSED [ 17%]
tests/test_config_flow.py::test_user_flow_returns_form_on_invalid_authentication PASSED [ 21%]
tests/test_config_flow.py::test_reauth_flow_updates_entry_and_aborts_on_success FAILED [ 25%]
tests/test_integration_setup.py::test_fake_homeassistant_stubs_include_docstrings[hass_init] PASSED [ 28%]
tests/test_integration_setup.py::test_fake_homeassistant_stubs_include_docstrings[hass_executor] PASSED [ 32%]
tests/test_integration_setup.py::test_fake_homeassistant_stubs_include_docstrings[config_entry_init] PASSED [ 35%]
tests/test_integration_setup.py::test_fake_homeassistant_stubs_include_docstrings[config_entry_unload] PASSED [ 39%]
tests/test_integration_setup.py::test_fake_homeassistant_stubs_include_docstrings[config_entry_setup] PASSED [ 42%]
tests/test_integration_setup.py::test_async_setup_initializes_domain PASSED [ 46%]
tests/test_integration_setup.py::test_async_setup_entry_creates_coordinator_and_forwards FAILED [ 50%]
tests/test_integration_setup.py::test_async_setup_entry_schedules_metadata_refresh FAILED [ 53%]
tests/test_integration_setup.py::test_async_setup_entry_uses_httpx_helper FAILED [ 57%]
tests/test_integration_setup.py::test_async_get_http_client_prefers_runtime_helper FAILED [ 60%]
tests/test_integration_setup.py::test_async_setup_entry_requests_tokens_when_missing FAILED [ 64%]
tests/test_integration_setup.py::test_async_setup_entry_schedules_token_refresh FAILED [ 67%]
tests/test_integration_setup.py::test_async_setup_entry_registers_reauth_service FAILED [ 71%]
tests/test_integration_setup.py::test_async_setup_entry_skips_credentials_when_tokens_attr_missing FAILED [ 75%]

=================================== FAILURES ===================================
_______________ test_options_flow_allows_configuring_iot_toggles _______________

    @pytest.mark.asyncio
    async def test_options_flow_allows_configuring_iot_toggles() -> None:
        """Options flow should expose IoT enablement toggles only."""
    
        # Ensure the local config_entries alias exists (it may be provided by the
        # real Home Assistant package in some environments).
        try:
            cfg = config_entries
        except NameError:
            import homeassistant.config_entries as cfg
    
>       entry = cfg.ConfigEntry(data={"enable_iot": True})
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       TypeError: ConfigEntry.__init__() missing 9 required keyword-only arguments: 'discovery_keys', 'domain', 'minor_version', 'options', 'source', 'subentries_data', 'title', 'unique_id', and 'version'

tests/test_config_flow.py:183: TypeError
---------------------------- Captured stderr setup -----------------------------
DEBUG:asyncio:Using selector: KqueueSelector
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:64 Using selector: KqueueSelector
_____________ test_reauth_flow_updates_entry_and_aborts_on_success _____________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x1114fdf10>

    @pytest.mark.asyncio
    async def test_reauth_flow_updates_entry_and_aborts_on_success(
        monkeypatch: pytest.MonkeyPatch,
    ) -> None:
        """Reauthentication should update the stored credentials and abort the flow."""
    
>       entry = config_entries.ConfigEntry(
                ^^^^^^^^^^^^^^
            data={
                "email": "user@example.com",
                "password": "old",
                "enable_iot": True,
                "enable_iot_state_updates": True,
                "enable_iot_commands": False,
                "enable_iot_refresh": True,
            }
        )
E       NameError: name 'config_entries' is not defined

tests/test_config_flow.py:276: NameError
---------------------------- Captured stderr setup -----------------------------
DEBUG:asyncio:Using selector: KqueueSelector
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:64 Using selector: KqueueSelector
___________ test_async_setup_entry_creates_coordinator_and_forwards ____________

tmp_path = PosixPath('/private/var/folders/sc/xq3g1qgx3hd0gl10w2l8rnm80000gn/T/pytest-of-tglenn/pytest-52/test_async_setup_entry_creates0')
tmp_path_factory = TempPathFactory(_given_basetemp=None, _trace=<pluggy._tracing.TagTracerSub object at 0x11091b6f0>, _basetemp=PosixPath.../folders/sc/xq3g1qgx3hd0gl10w2l8rnm80000gn/T/pytest-of-tglenn/pytest-52'), _retention_count=3, _retention_policy='all')
request = <FixtureRequest for <Coroutine test_async_setup_entry_creates_coordinator_and_forwards>>
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x110acc130>

    @pytest.mark.asyncio
    async def test_async_setup_entry_creates_coordinator_and_forwards(
        tmp_path, tmp_path_factory, request, monkeypatch
    ):
        """Setup entry should create the coordinator and forward platforms."""
    
        hass = FakeHass(config_dir=str(tmp_path))
        entry = FakeConfigEntry(
            entry_id="abc123",
            data={
                "email": "user@example.com",
                "password": "secret",
                "enable_iot": False,
                "enable_iot_state_updates": False,
                "enable_iot_commands": False,
                "enable_iot_refresh": False,
            },
        )
    
        class FakeClient:
            def __init__(self, *args: Any, **kwargs: Any) -> None:
                self.closed = False
    
            async def aclose(self) -> None:
                self.closed = True
    
        class FakeAuth:
            def __init__(self, hass: Any, client: Any) -> None:
                self.hass = hass
                self.client = client
                self.initialized = False
                self.tokens: Any | None = None
    
            async def async_initialize(self) -> None:
                self.initialized = True
    
            async def async_login(self, email: str, password: str) -> Any:
                self.tokens = SimpleNamespace(
                    access_token="token", should_refresh=lambda *_: False
                )
                return self.tokens
    
            async def async_get_access_token(self) -> str:
                if self.tokens is None:
                    raise RuntimeError("No tokens")
                return self.tokens.access_token
    
        class FakeApiClient:
            def __init__(self, hass: Any, client: Any, auth: Any) -> None:
                self.hass = hass
                self.client = client
                self.auth = auth
    
        class FakeCoordinator:
            def __init__(self, **kwargs: Any) -> None:
                self.kwargs = kwargs
                self.refreshed = False
    
            async def async_config_entry_first_refresh(self) -> None:
                self.refreshed = True
    
            def cancel_refresh(self) -> None:
                pass
    
        async def fake_get_async_client(
            hass: Any, *, verify_ssl: bool = True
        ) -> FakeClient:
            return FakeClient()
    
        monkeypatch.setattr(
            integration,
            "httpx",
            SimpleNamespace(
                AsyncClient=FakeClient,
                URL=lambda url, base_url=None: (
                    f"{base_url.rstrip('/')}/{url.lstrip('/')}" if base_url else url
                ),
            ),
            raising=False,
        )
        monkeypatch.setattr(integration, "_REAUTH_SERVICE_REGISTERED", False, raising=False)
        monkeypatch.setattr(
            sys.modules["homeassistant.helpers.httpx_client"],
            "get_async_client",
            fake_get_async_client,
            raising=False,
        )
        monkeypatch.setattr(integration, "_get_auth_class", lambda: FakeAuth, raising=False)
        monkeypatch.setattr(
            integration, "_get_device_client_class", lambda: FakeApiClient, raising=False
        )
        monkeypatch.setattr(
            integration, "_get_coordinator_class", lambda: FakeCoordinator, raising=False
        )
    
        async def _prepare_iot(*args: Any, **kwargs: Any) -> tuple[Any, ...]:
            return None, False, False, False
    
        monkeypatch.setattr(
            integration,
            "_async_prepare_iot_runtime",
            _prepare_iot,
            raising=False,
        )
    
>       assert await integration.async_setup_entry(hass, entry) is True
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_integration_setup.py:370: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
custom_components/govee/__init__.py:134: in async_setup_entry
    entity_registry = _get_entity_registry(hass)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^
custom_components/govee/__init__.py:242: in _get_entity_registry
    return er.async_get(hass)
           ^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/homeassistant/helpers/singleton.py:58: in wrapped
    hass.data[data_key] = func(hass)
                          ^^^^^^^^^^
.venv/lib/python3.13/site-packages/homeassistant/helpers/entity_registry.py:1751: in async_get
    return EntityRegistry(hass)
           ^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <homeassistant.helpers.entity_registry.EntityRegistry object at 0x111579160>
hass = <test_integration_setup.FakeHass object at 0x110f047d0>

    def __init__(self, hass: HomeAssistant) -> None:
        """Initialize the registry."""
        self.hass = hass
        self._store = EntityRegistryStore(
            hass,
            STORAGE_VERSION_MAJOR,
            STORAGE_KEY,
            atomic_writes=True,
            minor_version=STORAGE_VERSION_MINOR,
        )
>       self.hass.bus.async_listen(
        ^^^^^^^^^^^^^^^^^^^^^^^^^^
            EVENT_DEVICE_REGISTRY_UPDATED,
            self.async_device_modified,
        )
E       AttributeError: 'types.SimpleNamespace' object has no attribute 'async_listen'. Did you mean: 'async_listen_once'?

.venv/lib/python3.13/site-packages/homeassistant/helpers/entity_registry.py:828: AttributeError
---------------------------- Captured stderr setup -----------------------------
DEBUG:asyncio:Using selector: KqueueSelector
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:64 Using selector: KqueueSelector
______________ test_async_setup_entry_schedules_metadata_refresh _______________

tmp_path = PosixPath('/private/var/folders/sc/xq3g1qgx3hd0gl10w2l8rnm80000gn/T/pytest-of-tglenn/pytest-52/test_async_setup_entry_schedul0')
tmp_path_factory = TempPathFactory(_given_basetemp=None, _trace=<pluggy._tracing.TagTracerSub object at 0x11091b6f0>, _basetemp=PosixPath.../folders/sc/xq3g1qgx3hd0gl10w2l8rnm80000gn/T/pytest-of-tglenn/pytest-52'), _retention_count=3, _retention_policy='all')
request = <FixtureRequest for <Coroutine test_async_setup_entry_schedules_metadata_refresh>>
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x111582dd0>

    @pytest.mark.asyncio
    async def test_async_setup_entry_schedules_metadata_refresh(
        tmp_path, tmp_path_factory, request, monkeypatch
    ) -> None:
        """Setup should schedule coordinator refresh callbacks for metadata."""
    
        hass = FakeHass(config_dir=str(tmp_path))
        entry = FakeConfigEntry(entry_id="refresh", data={})
    
        class FakeAuth:
            def __init__(self, hass: Any, client: Any) -> None:
                self.tokens = SimpleNamespace(
                    access_token="token", should_refresh=lambda *_: False
                )
    
            async def async_initialize(self) -> None:
                return None
    
            async def async_login(self, email: str, password: str) -> Any:
                return self.tokens
    
            async def async_get_access_token(self) -> str:
                return self.tokens.access_token
    
        class FakeDeviceClient:
            def __init__(self, hass: Any, client: Any, auth: Any) -> None:
                self.hass = hass
                self.client = client
                self.auth = auth
    
        class FakeCoordinator:
            def __init__(self, **_: Any) -> None:
                self.refreshed = False
                self.scheduled: Callable[[], Any] | None = None
    
            async def async_config_entry_first_refresh(self) -> None:
                self.refreshed = True
    
            async def async_request_refresh(self) -> None:
                return None
    
            def async_schedule_refresh(self, callback: Callable[[], Any]) -> Any:
                self.scheduled = callback
                return SimpleNamespace(cancelled=False)
    
            def cancel_refresh(self) -> None:
                return None
    
        async def fake_get_async_client(
            hass_param: Any, *, verify_ssl: bool = True
        ) -> SimpleNamespace:
            return SimpleNamespace()
    
        monkeypatch.setattr(integration, "_REAUTH_SERVICE_REGISTERED", False, raising=False)
        monkeypatch.setattr(
            sys.modules["homeassistant.helpers.httpx_client"],
            "get_async_client",
            fake_get_async_client,
            raising=False,
        )
        monkeypatch.setattr(integration, "_get_auth_class", lambda: FakeAuth, raising=False)
        monkeypatch.setattr(
            integration, "_get_device_client_class", lambda: FakeDeviceClient, raising=False
        )
        monkeypatch.setattr(
            integration, "_get_coordinator_class", lambda: FakeCoordinator, raising=False
        )
    
        async def _prepare_iot(*args: Any, **kwargs: Any) -> tuple[Any, ...]:
            return None, False, False, False
    
        monkeypatch.setattr(
            integration,
            "_async_prepare_iot_runtime",
            _prepare_iot,
            raising=False,
        )
    
>       assert await integration.async_setup_entry(hass, entry) is True
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_integration_setup.py:457: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
custom_components/govee/__init__.py:134: in async_setup_entry
    entity_registry = _get_entity_registry(hass)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^
custom_components/govee/__init__.py:242: in _get_entity_registry
    return er.async_get(hass)
           ^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/homeassistant/helpers/singleton.py:58: in wrapped
    hass.data[data_key] = func(hass)
                          ^^^^^^^^^^
.venv/lib/python3.13/site-packages/homeassistant/helpers/entity_registry.py:1751: in async_get
    return EntityRegistry(hass)
           ^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <homeassistant.helpers.entity_registry.EntityRegistry object at 0x1115c8a50>
hass = <test_integration_setup.FakeHass object at 0x110f06990>

    def __init__(self, hass: HomeAssistant) -> None:
        """Initialize the registry."""
        self.hass = hass
        self._store = EntityRegistryStore(
            hass,
            STORAGE_VERSION_MAJOR,
            STORAGE_KEY,
            atomic_writes=True,
            minor_version=STORAGE_VERSION_MINOR,
        )
>       self.hass.bus.async_listen(
        ^^^^^^^^^^^^^^^^^^^^^^^^^^
            EVENT_DEVICE_REGISTRY_UPDATED,
            self.async_device_modified,
        )
E       AttributeError: 'types.SimpleNamespace' object has no attribute 'async_listen'. Did you mean: 'async_listen_once'?

.venv/lib/python3.13/site-packages/homeassistant/helpers/entity_registry.py:828: AttributeError
---------------------------- Captured stderr setup -----------------------------
DEBUG:asyncio:Using selector: KqueueSelector
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:64 Using selector: KqueueSelector
___________________ test_async_setup_entry_uses_httpx_helper ___________________

tmp_path = PosixPath('/private/var/folders/sc/xq3g1qgx3hd0gl10w2l8rnm80000gn/T/pytest-of-tglenn/pytest-52/test_async_setup_entry_uses_ht0')
tmp_path_factory = TempPathFactory(_given_basetemp=None, _trace=<pluggy._tracing.TagTracerSub object at 0x11091b6f0>, _basetemp=PosixPath.../folders/sc/xq3g1qgx3hd0gl10w2l8rnm80000gn/T/pytest-of-tglenn/pytest-52'), _retention_count=3, _retention_policy='all')
request = <FixtureRequest for <Coroutine test_async_setup_entry_uses_httpx_helper>>
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x1114d8910>

    @pytest.mark.asyncio
    async def test_async_setup_entry_uses_httpx_helper(
        tmp_path, tmp_path_factory, request, monkeypatch
    ):
        """The integration should rely on Home Assistant's HTTPX helper."""
    
        hass = FakeHass(config_dir=str(tmp_path))
        entry = FakeConfigEntry(entry_id="helper", data={})
    
        fake_client = object()
    
        class FakeAuth:
            def __init__(self, hass: Any, client: Any) -> None:
                self.hass = hass
                self.client = client
                self.initialized = False
                self.tokens = object()
    
            async def async_initialize(self) -> None:
                self.initialized = True
    
        class FakeApiClient:
            def __init__(self, hass: Any, client: Any, auth: Any) -> None:
                self.hass = hass
                self.client = client
                self.auth = auth
    
        class FakeCoordinator:
            def __init__(self, **kwargs: Any) -> None:
                self.kwargs = kwargs
    
            async def async_config_entry_first_refresh(self) -> None:
                pass
    
        calls: list[tuple[Any, ...]] = []
    
        def _get_async_client(hass_param: Any, /, **_: Any) -> Any:
            calls.append((hass_param,))
            return fake_client
    
        monkeypatch.setattr(
            integration,
            "_httpx_get_async_client",
            _get_async_client,
            raising=False,
        )
        monkeypatch.setattr(
            sys.modules["homeassistant.helpers.httpx_client"],
            "get_async_client",
            _get_async_client,
            raising=False,
        )
        monkeypatch.setattr(
            integration,
            "httpx_client",
            sys.modules["homeassistant.helpers.httpx_client"],
            raising=False,
        )
    
        monkeypatch.setattr(integration, "_get_auth_class", lambda: FakeAuth, raising=False)
        monkeypatch.setattr(
            integration, "_get_device_client_class", lambda: FakeApiClient, raising=False
        )
        monkeypatch.setattr(
            integration, "_get_coordinator_class", lambda: FakeCoordinator, raising=False
        )
    
        async def _prepare_iot(*args: Any, **kwargs: Any) -> tuple[Any, ...]:
            return None, False, False, False
    
        monkeypatch.setattr(
            integration,
            "_async_prepare_iot_runtime",
            _prepare_iot,
            raising=False,
        )
    
>       assert await integration.async_setup_entry(hass, entry) is True
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_integration_setup.py:547: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
custom_components/govee/__init__.py:134: in async_setup_entry
    entity_registry = _get_entity_registry(hass)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^
custom_components/govee/__init__.py:242: in _get_entity_registry
    return er.async_get(hass)
           ^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/homeassistant/helpers/singleton.py:58: in wrapped
    hass.data[data_key] = func(hass)
                          ^^^^^^^^^^
.venv/lib/python3.13/site-packages/homeassistant/helpers/entity_registry.py:1751: in async_get
    return EntityRegistry(hass)
           ^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <homeassistant.helpers.entity_registry.EntityRegistry object at 0x1115ca5d0>
hass = <test_integration_setup.FakeHass object at 0x110dffe10>

    def __init__(self, hass: HomeAssistant) -> None:
        """Initialize the registry."""
        self.hass = hass
        self._store = EntityRegistryStore(
            hass,
            STORAGE_VERSION_MAJOR,
            STORAGE_KEY,
            atomic_writes=True,
            minor_version=STORAGE_VERSION_MINOR,
        )
>       self.hass.bus.async_listen(
        ^^^^^^^^^^^^^^^^^^^^^^^^^^
            EVENT_DEVICE_REGISTRY_UPDATED,
            self.async_device_modified,
        )
E       AttributeError: 'types.SimpleNamespace' object has no attribute 'async_listen'. Did you mean: 'async_listen_once'?

.venv/lib/python3.13/site-packages/homeassistant/helpers/entity_registry.py:828: AttributeError
---------------------------- Captured stderr setup -----------------------------
DEBUG:asyncio:Using selector: KqueueSelector
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:64 Using selector: KqueueSelector
______________ test_async_get_http_client_prefers_runtime_helper _______________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x11990bd20>

    def test_async_get_http_client_prefers_runtime_helper(monkeypatch) -> None:
        """Helper module injected after import should supply the HTTP client."""
    
        hass = FakeHass(config_dir="/tmp")
        sentinel_client = object()
    
        helper_module = ModuleType("homeassistant.helpers.httpx_client")
        helper_module.get_async_client = (
            lambda hass_param, **_: sentinel_client
        )  # type: ignore[attr-defined]
    
        monkeypatch.setattr(integration, "_httpx_get_async_client", None, raising=False)
        monkeypatch.setattr(integration, "httpx_client", helper_module, raising=False)
        monkeypatch.setattr(
            integration,
            "httpx",
            SimpleNamespace(
                AsyncClient=lambda *args, **kwargs: object(),
                URL=lambda url, base_url=None: (
                    f"{base_url.rstrip('/')}/{url.lstrip('/')}" if base_url else url
                ),
            ),
            raising=False,
        )
    
        loop = asyncio.get_event_loop()
>       client = loop.run_until_complete(integration._async_get_http_client(hass))
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_integration_setup.py:585: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/opt/homebrew/Cellar/python@3.13/3.13.7/Frameworks/Python.framework/Versions/3.13/lib/python3.13/asyncio/base_events.py:725: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

hass = <test_integration_setup.FakeHass object at 0x119a20770>

    async def _async_get_http_client(hass: Any) -> object:
>       return await _api._async_get_http_client(hass)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       AttributeError: module 'custom_components.govee.api' has no attribute '_async_get_http_client'

custom_components/govee/__init__.py:67: AttributeError
_____________ test_async_setup_entry_requests_tokens_when_missing ______________

tmp_path = PosixPath('/private/var/folders/sc/xq3g1qgx3hd0gl10w2l8rnm80000gn/T/pytest-of-tglenn/pytest-52/test_async_setup_entry_request0')
tmp_path_factory = TempPathFactory(_given_basetemp=None, _trace=<pluggy._tracing.TagTracerSub object at 0x11091b6f0>, _basetemp=PosixPath.../folders/sc/xq3g1qgx3hd0gl10w2l8rnm80000gn/T/pytest-of-tglenn/pytest-52'), _retention_count=3, _retention_policy='all')
request = <FixtureRequest for <Coroutine test_async_setup_entry_requests_tokens_when_missing>>
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x110e92f20>

    @pytest.mark.asyncio
    async def test_async_setup_entry_requests_tokens_when_missing(
        tmp_path, tmp_path_factory, request, monkeypatch
    ):
        """If initialization yields no tokens the setup should request credentials."""
    
        hass = FakeHass(config_dir=str(tmp_path))
        entry = FakeConfigEntry(
            entry_id="needs-tokens",
            data={"email": "configured@example.com", "password": "ignored"},
        )
    
        helper_module = ModuleType("homeassistant.helpers.httpx_client")
        helper_module.get_async_client = (
            lambda hass_param, **_: object()
        )  # type: ignore[attr-defined]
        monkeypatch.setattr(integration, "httpx_client", helper_module, raising=False)
    
        def _track_interval(
            hass_param: Any, action: Callable[[Any], Awaitable[None]], interval: Any
        ) -> Callable[[], None]:
            hass_param.tracked_interval = (action, interval)
    
            def _cancel() -> None:
                hass_param.tracked_interval = None
    
            return _cancel
    
        monkeypatch.setattr(
            integration,
            "async_track_time_interval",
            _track_interval,
            raising=False,
        )
    
        def _track_interval(
            hass_param: Any, action: Callable[[Any], Awaitable[None]], interval: Any
        ) -> Callable[[], None]:
            hass_param.tracked_interval = (action, interval)
    
            def _cancel() -> None:
                hass_param.tracked_interval = None
    
            return _cancel
    
        monkeypatch.setattr(
            integration,
            "async_track_time_interval",
            _track_interval,
            raising=False,
        )
    
        class FakeTokens:
            pass
    
        issued_tokens = FakeTokens()
    
        class FakeAuth:
            def __init__(self, hass_param: Any, client: Any) -> None:
                self.hass = hass_param
                self.client = client
                self.initialized = False
                self._tokens: FakeTokens | None = None
                self.login_calls: list[tuple[str, str]] = []
    
            async def async_initialize(self) -> None:
                self.initialized = True
    
            @property
            def tokens(self) -> FakeTokens | None:
                return self._tokens
    
            async def async_login(self, email: str, password: str) -> FakeTokens:
                self.login_calls.append((email, password))
                self._tokens = issued_tokens
                return issued_tokens
    
        class FakeApiClient:
            def __init__(self, hass_param: Any, client: Any, auth: Any) -> None:
                self.hass = hass_param
                self.client = client
                self.auth = auth
    
        class FakeCoordinator:
            def __init__(self, **kwargs: Any) -> None:
                self.kwargs = kwargs
    
            async def async_config_entry_first_refresh(self) -> None:
                pass
    
        monkeypatch.setattr(integration, "_get_auth_class", lambda: FakeAuth, raising=False)
        monkeypatch.setattr(
            integration, "_get_device_client_class", lambda: FakeApiClient, raising=False
        )
        monkeypatch.setattr(
            integration, "_get_coordinator_class", lambda: FakeCoordinator, raising=False
        )
    
        async def _prepare_iot(*args: Any, **kwargs: Any) -> tuple[Any, ...]:
            return None, False, False, False
    
        monkeypatch.setattr(
            integration,
            "_async_prepare_iot_runtime",
            _prepare_iot,
            raising=False,
        )
    
        hass.flow_results.append(
            {
                "type": "create_entry",
                "data": {"email": "user@example.com", "password": "secret"},
            }
        )
    
>       assert await integration.async_setup_entry(hass, entry) is True
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_integration_setup.py:706: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
custom_components/govee/__init__.py:134: in async_setup_entry
    entity_registry = _get_entity_registry(hass)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^
custom_components/govee/__init__.py:242: in _get_entity_registry
    return er.async_get(hass)
           ^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/homeassistant/helpers/singleton.py:58: in wrapped
    hass.data[data_key] = func(hass)
                          ^^^^^^^^^^
.venv/lib/python3.13/site-packages/homeassistant/helpers/entity_registry.py:1751: in async_get
    return EntityRegistry(hass)
           ^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <homeassistant.helpers.entity_registry.EntityRegistry object at 0x119a215b0>
hass = <test_integration_setup.FakeHass object at 0x110ac56d0>

    def __init__(self, hass: HomeAssistant) -> None:
        """Initialize the registry."""
        self.hass = hass
        self._store = EntityRegistryStore(
            hass,
            STORAGE_VERSION_MAJOR,
            STORAGE_KEY,
            atomic_writes=True,
            minor_version=STORAGE_VERSION_MINOR,
        )
>       self.hass.bus.async_listen(
        ^^^^^^^^^^^^^^^^^^^^^^^^^^
            EVENT_DEVICE_REGISTRY_UPDATED,
            self.async_device_modified,
        )
E       AttributeError: 'types.SimpleNamespace' object has no attribute 'async_listen'. Did you mean: 'async_listen_once'?

.venv/lib/python3.13/site-packages/homeassistant/helpers/entity_registry.py:828: AttributeError
---------------------------- Captured stderr setup -----------------------------
DEBUG:asyncio:Using selector: KqueueSelector
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:64 Using selector: KqueueSelector
________________ test_async_setup_entry_schedules_token_refresh ________________

tmp_path = PosixPath('/private/var/folders/sc/xq3g1qgx3hd0gl10w2l8rnm80000gn/T/pytest-of-tglenn/pytest-52/test_async_setup_entry_schedul1')
tmp_path_factory = TempPathFactory(_given_basetemp=None, _trace=<pluggy._tracing.TagTracerSub object at 0x11091b6f0>, _basetemp=PosixPath.../folders/sc/xq3g1qgx3hd0gl10w2l8rnm80000gn/T/pytest-of-tglenn/pytest-52'), _retention_count=3, _retention_policy='all')
request = <FixtureRequest for <Coroutine test_async_setup_entry_schedules_token_refresh>>
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x1114d8b40>

    @pytest.mark.asyncio
    async def test_async_setup_entry_schedules_token_refresh(
        tmp_path, tmp_path_factory, request, monkeypatch
    ):
        """Token refresh should be periodically scheduled and cancellable."""
    
        hass = FakeHass(config_dir=str(tmp_path))
        entry = FakeConfigEntry(entry_id="refresh", data={})
    
        helper_module = ModuleType("homeassistant.helpers.httpx_client")
        helper_module.get_async_client = (
            lambda hass_param, **_: object()
        )  # type: ignore[attr-defined]
        monkeypatch.setattr(integration, "httpx_client", helper_module, raising=False)
        recorded: list[tuple[Callable[[Any], Awaitable[None]], Any]] = []
    
        def _track_interval(
            hass_param: Any, action: Callable[[Any], Awaitable[None]], interval: Any
        ) -> Callable[[], None]:
            recorded.append((action, interval))
            hass_param.tracked_interval = (action, interval)
    
            def _cancel() -> None:
                hass_param.tracked_interval = None
    
            return _cancel
    
        monkeypatch.setattr(
            integration,
            "async_track_time_interval",
            _track_interval,
            raising=False,
        )
    
        class FakeAuth:
            def __init__(self, hass_param: Any, client: Any) -> None:
                self.hass = hass_param
                self.client = client
                self.initialized = False
                self._tokens = object()
                self.access_calls = 0
    
            async def async_initialize(self) -> None:
                self.initialized = True
    
            @property
            def tokens(self) -> object:
                return self._tokens
    
            async def async_get_access_token(self) -> str:
                self.access_calls += 1
                return "token"
    
        class FakeApiClient:
            def __init__(self, hass_param: Any, client: Any, auth: Any) -> None:
                self.hass = hass_param
                self.client = client
                self.auth = auth
    
        class FakeCoordinator:
            def __init__(self, **kwargs: Any) -> None:
                self.kwargs = kwargs
    
            async def async_config_entry_first_refresh(self) -> None:
                pass
    
        monkeypatch.setattr(integration, "_get_auth_class", lambda: FakeAuth, raising=False)
        monkeypatch.setattr(
            integration, "_get_device_client_class", lambda: FakeApiClient, raising=False
        )
        monkeypatch.setattr(
            integration, "_get_coordinator_class", lambda: FakeCoordinator, raising=False
        )
    
        async def _prepare_iot(*args: Any, **kwargs: Any) -> tuple[Any, ...]:
            return None, False, False, False
    
        monkeypatch.setattr(
            integration,
            "_async_prepare_iot_runtime",
            _prepare_iot,
            raising=False,
        )
    
>       assert await integration.async_setup_entry(hass, entry) is True
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_integration_setup.py:800: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
custom_components/govee/__init__.py:134: in async_setup_entry
    entity_registry = _get_entity_registry(hass)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^
custom_components/govee/__init__.py:242: in _get_entity_registry
    return er.async_get(hass)
           ^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/homeassistant/helpers/singleton.py:58: in wrapped
    hass.data[data_key] = func(hass)
                          ^^^^^^^^^^
.venv/lib/python3.13/site-packages/homeassistant/helpers/entity_registry.py:1751: in async_get
    return EntityRegistry(hass)
           ^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <homeassistant.helpers.entity_registry.EntityRegistry object at 0x119a22fd0>
hass = <test_integration_setup.FakeHass object at 0x110eb59d0>

    def __init__(self, hass: HomeAssistant) -> None:
        """Initialize the registry."""
        self.hass = hass
        self._store = EntityRegistryStore(
            hass,
            STORAGE_VERSION_MAJOR,
            STORAGE_KEY,
            atomic_writes=True,
            minor_version=STORAGE_VERSION_MINOR,
        )
>       self.hass.bus.async_listen(
        ^^^^^^^^^^^^^^^^^^^^^^^^^^
            EVENT_DEVICE_REGISTRY_UPDATED,
            self.async_device_modified,
        )
E       AttributeError: 'types.SimpleNamespace' object has no attribute 'async_listen'. Did you mean: 'async_listen_once'?

.venv/lib/python3.13/site-packages/homeassistant/helpers/entity_registry.py:828: AttributeError
---------------------------- Captured stderr setup -----------------------------
DEBUG:asyncio:Using selector: KqueueSelector
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:64 Using selector: KqueueSelector
_______________ test_async_setup_entry_registers_reauth_service ________________

tmp_path = PosixPath('/private/var/folders/sc/xq3g1qgx3hd0gl10w2l8rnm80000gn/T/pytest-of-tglenn/pytest-52/test_async_setup_entry_registe0')
tmp_path_factory = TempPathFactory(_given_basetemp=None, _trace=<pluggy._tracing.TagTracerSub object at 0x11091b6f0>, _basetemp=PosixPath.../folders/sc/xq3g1qgx3hd0gl10w2l8rnm80000gn/T/pytest-of-tglenn/pytest-52'), _retention_count=3, _retention_policy='all')
request = <FixtureRequest for <Coroutine test_async_setup_entry_registers_reauth_service>>
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x1115df230>

    @pytest.mark.asyncio
    async def test_async_setup_entry_registers_reauth_service(
        tmp_path, tmp_path_factory, request, monkeypatch
    ):
        """The integration should expose a service to force reauthentication."""
    
        hass = FakeHass(config_dir=str(tmp_path))
        entry = FakeConfigEntry(entry_id="service", data={})
    
        helper_module = ModuleType("homeassistant.helpers.httpx_client")
        helper_module.get_async_client = (
            lambda hass_param, **_: object()
        )  # type: ignore[attr-defined]
        monkeypatch.setattr(integration, "httpx_client", helper_module, raising=False)
        recorded: list[tuple[Callable[[Any], Awaitable[None]], Any]] = []
    
        def _track_interval(
            hass_param: Any, action: Callable[[Any], Awaitable[None]], interval: Any
        ) -> Callable[[], None]:
            recorded.append((action, interval))
            hass_param.tracked_interval = (action, interval)
    
            def _cancel() -> None:
                hass_param.tracked_interval = None
    
            return _cancel
    
        monkeypatch.setattr(
            integration,
            "async_track_time_interval",
            _track_interval,
            raising=False,
        )
    
        class FakeTokens:
            pass
    
        issued_tokens = FakeTokens()
    
        class FakeAuth:
            def __init__(self, hass_param: Any, client: Any) -> None:
                self.hass = hass_param
                self.client = client
                self.initialized = False
                self._tokens: FakeTokens | None = issued_tokens
                self.login_calls: list[tuple[str, str]] = []
    
            async def async_initialize(self) -> None:
                self.initialized = True
    
            @property
            def tokens(self) -> FakeTokens | None:
                return self._tokens
    
            async def async_login(self, email: str, password: str) -> FakeTokens:
                self.login_calls.append((email, password))
                self._tokens = issued_tokens
                return issued_tokens
    
        class FakeApiClient:
            def __init__(self, hass_param: Any, client: Any, auth: Any) -> None:
                self.hass = hass_param
                self.client = client
                self.auth = auth
    
        class FakeCoordinator:
            def __init__(self, **kwargs: Any) -> None:
                self.kwargs = kwargs
    
            async def async_config_entry_first_refresh(self) -> None:
                pass
    
        monkeypatch.setattr(integration, "_get_auth_class", lambda: FakeAuth, raising=False)
        monkeypatch.setattr(
            integration, "_get_device_client_class", lambda: FakeApiClient, raising=False
        )
        monkeypatch.setattr(
            integration, "_get_coordinator_class", lambda: FakeCoordinator, raising=False
        )
    
        async def _prepare_iot(*args: Any, **kwargs: Any) -> tuple[Any, ...]:
            return None, False, False, False
    
        monkeypatch.setattr(
            integration,
            "_async_prepare_iot_runtime",
            _prepare_iot,
            raising=False,
        )
    
>       assert await integration.async_setup_entry(hass, entry) is True
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_integration_setup.py:906: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
custom_components/govee/__init__.py:134: in async_setup_entry
    entity_registry = _get_entity_registry(hass)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^
custom_components/govee/__init__.py:242: in _get_entity_registry
    return er.async_get(hass)
           ^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/homeassistant/helpers/singleton.py:58: in wrapped
    hass.data[data_key] = func(hass)
                          ^^^^^^^^^^
.venv/lib/python3.13/site-packages/homeassistant/helpers/entity_registry.py:1751: in async_get
    return EntityRegistry(hass)
           ^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <homeassistant.helpers.entity_registry.EntityRegistry object at 0x10d4015b0>
hass = <test_integration_setup.FakeHass object at 0x1115a8050>

    def __init__(self, hass: HomeAssistant) -> None:
        """Initialize the registry."""
        self.hass = hass
        self._store = EntityRegistryStore(
            hass,
            STORAGE_VERSION_MAJOR,
            STORAGE_KEY,
            atomic_writes=True,
            minor_version=STORAGE_VERSION_MINOR,
        )
>       self.hass.bus.async_listen(
        ^^^^^^^^^^^^^^^^^^^^^^^^^^
            EVENT_DEVICE_REGISTRY_UPDATED,
            self.async_device_modified,
        )
E       AttributeError: 'types.SimpleNamespace' object has no attribute 'async_listen'. Did you mean: 'async_listen_once'?

.venv/lib/python3.13/site-packages/homeassistant/helpers/entity_registry.py:828: AttributeError
---------------------------- Captured stderr setup -----------------------------
DEBUG:asyncio:Using selector: KqueueSelector
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:64 Using selector: KqueueSelector
______ test_async_setup_entry_skips_credentials_when_tokens_attr_missing _______

tmp_path = PosixPath('/private/var/folders/sc/xq3g1qgx3hd0gl10w2l8rnm80000gn/T/pytest-of-tglenn/pytest-52/test_async_setup_entry_skips_c0')
tmp_path_factory = TempPathFactory(_given_basetemp=None, _trace=<pluggy._tracing.TagTracerSub object at 0x11091b6f0>, _basetemp=PosixPath.../folders/sc/xq3g1qgx3hd0gl10w2l8rnm80000gn/T/pytest-of-tglenn/pytest-52'), _retention_count=3, _retention_policy='all')
request = <FixtureRequest for <Coroutine test_async_setup_entry_skips_credentials_when_tokens_attr_missing>>
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x1115df7e0>

    @pytest.mark.asyncio
    async def test_async_setup_entry_skips_credentials_when_tokens_attr_missing(
        tmp_path, tmp_path_factory, request, monkeypatch
    ):
        """Auth objects without a tokens attribute should not trigger reauth."""
    
        hass = FakeHass(config_dir=str(tmp_path))
        entry = FakeConfigEntry(
            entry_id="no-tokens",
            data={"email": "iot@example.com", "password": "secret"},
        )
    
        class FakeClient:
            def __init__(self, *args: Any, **kwargs: Any) -> None:
                pass
    
            async def aclose(self) -> None:
                pass
    
        class FakeAuth:
            def __init__(self, hass_param: Any, client: Any) -> None:
                self.hass = hass_param
                self.client = client
                self.login_calls: list[tuple[str, str]] = []
                self.tokens = None
    
            async def async_initialize(self) -> None:
                pass
    
            async def async_login(self, email: str, password: str) -> object:
                self.login_calls.append((email, password))
                return object()
    
        class FakeApiClient:
            def __init__(self, hass_param: Any, client: Any, auth: Any) -> None:
                self.hass = hass_param
                self.client = client
                self.auth = auth
    
        class FakeCoordinator:
            def __init__(self, **kwargs: Any) -> None:
                self.kwargs = kwargs
    
            async def async_config_entry_first_refresh(self) -> None:
                pass
    
        monkeypatch.setattr(
            integration,
            "httpx",
            SimpleNamespace(
                AsyncClient=FakeClient,
                URL=lambda url, base_url=None: (
                    f"{base_url.rstrip('/')}/{url.lstrip('/')}" if base_url else url
                ),
            ),
            raising=False,
        )
        monkeypatch.setattr(integration, "_get_auth_class", lambda: FakeAuth, raising=False)
        monkeypatch.setattr(
            integration, "_get_device_client_class", lambda: FakeApiClient, raising=False
        )
        monkeypatch.setattr(
            integration, "_get_coordinator_class", lambda: FakeCoordinator, raising=False
        )
    
        async def _fail_request(*args: Any, **kwargs: Any) -> dict[str, Any]:
            raise AssertionError("credentials should not be requested")
    
        monkeypatch.setattr(
            integration, "_async_request_credentials", _fail_request, raising=False
        )
    
        async def _prepare_iot(*args: Any, **kwargs: Any) -> tuple[Any, ...]:
            return None, False, False, False
    
        monkeypatch.setattr(
            integration,
            "_async_prepare_iot_runtime",
            _prepare_iot,
            raising=False,
        )
    
>       assert await integration.async_setup_entry(hass, entry) is True
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/test_integration_setup.py:1011: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
custom_components/govee/__init__.py:134: in async_setup_entry
    entity_registry = _get_entity_registry(hass)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^
custom_components/govee/__init__.py:242: in _get_entity_registry
    return er.async_get(hass)
           ^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/homeassistant/helpers/singleton.py:58: in wrapped
    hass.data[data_key] = func(hass)
                          ^^^^^^^^^^
.venv/lib/python3.13/site-packages/homeassistant/helpers/entity_registry.py:1751: in async_get
    return EntityRegistry(hass)
           ^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <homeassistant.helpers.entity_registry.EntityRegistry object at 0x1115ab130>
hass = <test_integration_setup.FakeHass object at 0x11156e250>

    def __init__(self, hass: HomeAssistant) -> None:
        """Initialize the registry."""
        self.hass = hass
        self._store = EntityRegistryStore(
            hass,
            STORAGE_VERSION_MAJOR,
            STORAGE_KEY,
            atomic_writes=True,
            minor_version=STORAGE_VERSION_MINOR,
        )
>       self.hass.bus.async_listen(
        ^^^^^^^^^^^^^^^^^^^^^^^^^^
            EVENT_DEVICE_REGISTRY_UPDATED,
            self.async_device_modified,
        )
E       AttributeError: 'types.SimpleNamespace' object has no attribute 'async_listen'. Did you mean: 'async_listen_once'?

.venv/lib/python3.13/site-packages/homeassistant/helpers/entity_registry.py:828: AttributeError
---------------------------- Captured stderr setup -----------------------------
DEBUG:asyncio:Using selector: KqueueSelector
------------------------------ Captured log setup ------------------------------
DEBUG    asyncio:selector_events.py:64 Using selector: KqueueSelector
--------------------------- Captured stderr teardown ---------------------------
DEBUG:asyncio:Close <_UnixSelectorEventLoop running=False closed=False debug=True>
---------------------------- Captured log teardown -----------------------------
DEBUG    asyncio:base_events.py:748 Close <_UnixSelectorEventLoop running=False closed=False debug=True>
=============================== warnings summary ===============================
tests/test_integration_setup.py::test_async_setup_entry_creates_coordinator_and_forwards
tests/test_integration_setup.py::test_async_setup_entry_schedules_metadata_refresh
tests/test_integration_setup.py::test_async_setup_entry_uses_httpx_helper
tests/test_integration_setup.py::test_async_setup_entry_requests_tokens_when_missing
tests/test_integration_setup.py::test_async_setup_entry_schedules_token_refresh
tests/test_integration_setup.py::test_async_setup_entry_registers_reauth_service
tests/test_integration_setup.py::test_async_setup_entry_skips_credentials_when_tokens_attr_missing
  /Users/tglenn/src/govee-ultimate/.venv/lib/python3.13/site-packages/homeassistant/helpers/httpx_client.py:128: RuntimeWarning: coroutine 'FakeHass._bus_listen_once' was never awaited
    hass.bus.async_listen_once(EVENT_HOMEASSISTANT_CLOSE, _async_close_client)
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED tests/test_config_flow.py::test_options_flow_allows_configuring_iot_toggles
FAILED tests/test_config_flow.py::test_reauth_flow_updates_entry_and_aborts_on_success
FAILED tests/test_integration_setup.py::test_async_setup_entry_creates_coordinator_and_forwards
FAILED tests/test_integration_setup.py::test_async_setup_entry_schedules_metadata_refresh
FAILED tests/test_integration_setup.py::test_async_setup_entry_uses_httpx_helper
FAILED tests/test_integration_setup.py::test_async_get_http_client_prefers_runtime_helper
FAILED tests/test_integration_setup.py::test_async_setup_entry_requests_tokens_when_missing
FAILED tests/test_integration_setup.py::test_async_setup_entry_schedules_token_refresh
FAILED tests/test_integration_setup.py::test_async_setup_entry_registers_reauth_service
FAILED tests/test_integration_setup.py::test_async_setup_entry_skips_credentials_when_tokens_attr_missing
!!!!!!!!!!!!!!!!!!!!!!!!!! stopping after 10 failures !!!!!!!!!!!!!!!!!!!!!!!!!!
================== 10 failed, 11 passed, 7 warnings in 0.45s ===================
