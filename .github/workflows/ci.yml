name: bump-version-on-label

on:
  pull_request:
    types: [labeled]

permissions:
  contents: read
  actions: read
  pull-requests: read

jobs:
  analyze_pr:
    name: Analyze PR (untrusted)
    permissions:
      contents: read
      actions: read
      pull-requests: read
    runs-on: ubuntu-latest
    outputs:
      head_repo: ${{ steps.meta.outputs.head_repo }}
      head_ref: ${{ steps.meta.outputs.head_ref }}
      is_fork: ${{ steps.meta.outputs.is_fork }}
      level: ${{ steps.level.outputs.level }}
    steps:
      - name: Get PR metadata
        id: meta
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            core.setOutput('head_repo', pr.head.repo.full_name);
            core.setOutput('head_ref', pr.head.ref);
            core.setOutput('is_fork', String(pr.head.repo.full_name !== pr.base.repo.full_name));

      - name: Determine bump level from label
        id: level
        run: |
          case "${{ github.event.label.name }}" in
            major|minor|patch) echo "level=${{ github.event.label.name }}" >> "$GITHUB_OUTPUT" ;;
            *) echo "Label not a version level: ${{ github.event.label.name }}" >&2; exit 78 ;;
          esac

      # Read-only checkout of PR code (NO CREDENTIALS). We only copy the manifest out.
      - name: Checkout PR head (read-only)
        uses: actions/checkout@v5
        with:
          repository: ${{ steps.meta.outputs.head_repo }}
          ref: ${{ steps.meta.outputs.head_ref }}
          fetch-depth: 1
          persist-credentials: false
          path: pr

      - name: Upload manifest artifact
        run: |
          mkdir -p artifact
          cp pr/custom_components/govee/manifest.json artifact/manifest.json
        shell: bash
      - uses: actions/upload-artifact@v4
        with:
          name: pr-manifest
          path: artifact/manifest.json

  bump_writeback:
    name: Bump and write back (trusted)
    needs: analyze_pr
    if: needs.analyze_pr.outputs.is_fork == 'false'
    permissions:
      contents: write
      pull-requests: write
      actions: read
    runs-on: ubuntu-latest
    steps:
      - name: Checkout base (trusted)
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          repository: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_repository.full_name || github.repository }}
          ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || '' }}
          path: base

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install bump deps (trusted)
        working-directory: base
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Download manifest artifact
        uses: actions/download-artifact@v4
        with:
          name: pr-manifest
          path: pr

      - name: Bump manifest using trusted code
        env:
          LEVEL: ${{ needs.analyze_pr.outputs.level }}
          PYTHONPATH: base
        run: |
          set -euo pipefail
          python -m scripts.bump_version \
            --manifest pr/manifest.json \
            --level "$LEVEL"

      - name: Write back manifest via API (no checkout of PR)
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = 'custom_components/govee/manifest.json';
            const content = fs.readFileSync('pr/manifest.json', 'utf8');

            const [owner, repo] = '${{ needs.analyze_pr.outputs.head_repo }}'.split('/');
            const branch = '${{ needs.analyze_pr.outputs.head_ref }}';

            // Try to get current file SHA so we can update in-place
            let sha = undefined;
            try {
              const res = await github.rest.repos.getContent({ owner, repo, path, ref: branch });
              if (Array.isArray(res.data)) throw new Error('Expected file, got directory listing');
              sha = res.data.sha;
            } catch (e) {
              // if 404, file may not exist yet on the branch; proceed without sha
              if (e.status !== 404) throw e;
            }

            await github.rest.repos.createOrUpdateFileContents({
              owner,
              repo,
              path,
              message: `chore(release): bump ${{ needs.analyze_pr.outputs.level }}`,
              content: Buffer.from(content, 'utf8').toString('base64'),
              branch,
              sha,
            });

      - name: Post PR comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `Bumped version (${process.env.LEVEL}) and updated manifest on \`${{ needs.analyze_pr.outputs.head_ref }}\`.`
            });
        env:
          LEVEL: ${{ needs.analyze_pr.outputs.level }}

  bump_writeback_fork:
    name: Bump to maintainer branch (fork fallback)
    needs: analyze_pr
    if: needs.analyze_pr.outputs.is_fork == 'true'
    permissions:
      contents: write
      pull-requests: write
      actions: read
    runs-on: ubuntu-latest
    steps:
      - name: Checkout base (trusted)
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          repository: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_repository.full_name || github.repository }}
          ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || '' }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install bump deps (trusted)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Download manifest artifact
        uses: actions/download-artifact@v4
        with:
          name: pr-manifest
          path: pr

      - name: Bump manifest (trusted)
        env:
          LEVEL: ${{ needs.analyze_pr.outputs.level }}
        run: |
          python -m scripts.bump_version --manifest pr/manifest.json --level "$LEVEL"

      - name: Create maintainer PR with bumped manifest
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore(release): bump ${{ needs.analyze_pr.outputs.level }}"
          title: "Bump version (${{ needs.analyze_pr.outputs.level }})"
          body: "Automated bump for a forked PR."
          branch: "bot/bump-${{ github.run_id }}"
          add-paths: |
            custom_components/govee/manifest.json
          delete-branch: true
