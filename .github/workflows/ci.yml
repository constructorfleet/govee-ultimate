name: CI

on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]
  push:
    branches:
      - '**'
  workflow_run:
    workflows: ['bump-version-on-label']
    types: [completed]

permissions:
  contents: write
  actions: read
  checks: read

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Ruff lint
        run: python3 -m ruff check .

  tests:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Pytest
        run: pytest

  tag:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    needs:
      - lint
      - tests
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Create tag for main merge
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const tagName = `ci-${context.runNumber}`;
            try {
              await github.rest.git.createRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `refs/tags/${tagName}`,
                sha: context.sha,
              });
              core.info(`Created tag ${tagName}`);
            } catch (error) {
              if (error.status === 422) {
                core.warning(`Tag ${tagName} already exists; skipping`);
              } else {
                throw error;
              }
            }
