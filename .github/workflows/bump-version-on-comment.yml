jobs:
  bump:
    if: >-
      github.event.issue.pull_request != null &&
      startsWith(github.event.comment.body, 'bump version')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      # 1) Trusted base repo (for the bump script)
      - name: Checkout base (trusted)
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          path: base

      # 2) Checkout PR head (untrusted code, but we won't execute it)
      - name: Checkout PR head branch
        uses: actions/checkout@v5
        with:
          # If PR is from a fork, this is the fork repo
          repository: ${{ github.event.issue.pull_request.head.repo.full_name }}
          ref: ${{ github.event.issue.pull_request.head.ref }}
          path: pr
          fetch-depth: 0
          # Important: don't auto-inject credentials into this checkout
          persist-credentials: false

      - name: Verify same-repo PR (fail if fork)
        run: |
          if [ "${{ github.event.issue.pull_request.head.repo.full_name }}" != "${{ github.repository }}" ]; then
            echo "PR is from a fork; GITHUB_TOKEN cannot push to contributor's repo."
            echo "Either use a maintainer PAT or handle fork PRs by opening a new branch/PR in the base repo."
            exit 1
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.12

      - name: Install bump deps (trusted)
        working-directory: base
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run bump script against PR tree
        env:
          LEVEL: ${{ steps.parse.outputs.level }}
        run: |
          set -euo pipefail
          # Run the trusted script from base/, targeting files inside pr/
          python -m base.scripts.bump_version \
            --manifest pr/custom_components/govee/manifest.json \
            --level "$LEVEL"

      - name: Commit the change on PR branch
        working-directory: pr
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add custom_components/govee/manifest.json
          git commit -m "chore: bump version (${LEVEL}) from comment"

      - name: Push back to PR head branch
        uses: actions-js/push@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          directory: pr
          branch: ${{ github.event.issue.pull_request.head.ref }}